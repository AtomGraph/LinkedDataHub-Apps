@prefix def:    <https://w3id.org/atomgraph/linkeddatahub/default#> .
@prefix ldh:    <https://w3id.org/atomgraph/linkeddatahub#> .
@prefix rdf:    <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix xsd:    <http://www.w3.org/2001/XMLSchema#> .
@prefix dh:     <https://www.w3.org/ns/ldt/document-hierarchy#> .
@prefix dct:    <http://purl.org/dc/terms/> .
@prefix sioc:   <http://rdfs.org/sioc/ns#> .

<> a dh:Item ;
    sioc:has_container <..> ;
    dct:title "Packages" ;
    dct:description "Package management for LinkedDataHub applications" ;
    rdf:_1 <#content> .

<#content> a ldh:XHTML ;
    rdf:value """<div xmlns="http://www.w3.org/1999/xhtml">
<p class="lead">Packages are reusable bundles of ontologies and stylesheets that provide vocabulary support with custom rendering for specific RDF vocabularies.</p>
<div class="alert alert-info">
<p><strong>Note:</strong> Packages are <strong>declarative only</strong> (RDF + XSLT). They contain no Java code and integrate at installation-time, not runtime.</p>
</div>
<div>
<h2 id="what-are-packages">What are packages?</h2>
<p>A LinkedDataHub package is a reusable component that bundles together a vocabulary ontology and XSLT templates into a single installable unit. Packages enable:</p>
<ul>
<li>Rapid application setup with pre-configured domain vocabularies</li>
<li>Sharing and reusing common vocabulary definitions</li>
<li>Custom rendering for vocabulary-specific resources</li>
<li>Modular extension of dataspace functionality</li>
</ul>
</div>
<div>
<h2 id="package-structure">Package structure</h2>
<p>Each package consists of two files:</p>
<dl>
<dt><code>ns.ttl</code> - Package ontology</dt>
<dd>An RDF ontology file that imports the external vocabulary using <code>owl:imports</code> and defines template blocks (<code>ldh:template</code>) for custom views. Template blocks are SPARQL-based views attached to RDF types from the imported vocabulary.</dd>
<dt><code>layout.xsl</code> - XSLT stylesheet</dt>
<dd>XSLT transformation file with templates that override default rendering using system modes like <code>bs2:*</code> (Bootstrap 2.3.2 components) and <code>xhtml:*</code> (XHTML elements). See <a href="../stylesheets/" target="_blank">Stylesheets reference</a> for details on XSLT customization.</dd>
</dl>
<p>Package files are organized in the LinkedDataHub-Apps repository:</p>
<pre>packages/
├── package-name/
│   ├── ns.ttl         # Ontology with template blocks
│   └── layout.xsl     # XSLT stylesheet</pre>
<p>Package metadata is published as Linked Data that resolves from the package URI (e.g., <code>https://packages.linkeddatahub.com/skos/#this</code>).</p>
</div>
<div>
<h2 id="package-metadata">Package metadata</h2>
<p>Package metadata is published as Linked Data that resolves from the package URI using standard LinkedDataHub properties:</p>
<dl>
<dt><code>lapp:Package</code></dt>
<dd>The RDF class for package descriptors</dd>
<dt><code>rdfs:label</code></dt>
<dd>Human-readable package name</dd>
<dt><code>dct:description</code></dt>
<dd>Package description and purpose</dd>
<dt><code>ldt:ontology</code></dt>
<dd>Points to the package ontology URI (from LDT vocabulary)</dd>
<dt><code>ac:stylesheet</code></dt>
<dd>Points to the package stylesheet URI (from AtomGraph Client vocabulary)</dd>
</dl>
<p>Example package metadata:</p>
<pre>@prefix lapp: &lt;https://w3id.org/atomgraph/linkeddatahub/apps#&gt; .
@prefix ldt:  &lt;https://www.w3.org/ns/ldt#&gt; .
@prefix ac:   &lt;https://w3id.org/atomgraph/client#&gt; .

&lt;https://packages.linkeddatahub.com/skos/#this&gt; a lapp:Package ;
    rdfs:label "SKOS Package" ;
    dct:description "SKOS vocabulary support with custom templates" ;
    ldt:ontology &lt;https://raw.githubusercontent.com/AtomGraph/LinkedDataHub-Apps/master/packages/skos/ns.ttl&gt; ;
    ac:stylesheet &lt;https://raw.githubusercontent.com/AtomGraph/LinkedDataHub-Apps/master/packages/skos/layout.xsl&gt; .</pre>
</div>
<div>
<h2 id="package-ontology">Package ontology (ns.ttl)</h2>
<p>The package ontology file contains two layers:</p>
<h3 id="vocabulary-import">Vocabulary import</h3>
<p>Imports the external vocabulary using <code>owl:imports</code>. See <a href="../ontologies/" target="_blank">Ontologies reference</a> for ontology management details.</p>
<pre>&lt;https://packages.linkeddatahub.com/skos/ns.ttl&gt; a owl:Ontology ;
    owl:imports &lt;http://www.w3.org/2004/02/skos/core&gt; .</pre>
<h3 id="template-blocks">Template blocks (ldh:template)</h3>
<p>SPARQL-based views attached to RDF types from the imported vocabulary:</p>
<pre>skos:Concept ldh:template ns:NarrowerConcepts .

ns:NarrowerConcepts a ldh:View ;
    dct:title "Narrower concepts" ;
    spin:query ns:SelectNarrowerConcepts .

ns:SelectNarrowerConcepts a sp:Select ;
    sp:text """
    SELECT DISTINCT ?narrower
    WHERE { GRAPH ?graph { $about skos:narrower ?narrower } }
    ORDER BY ?narrower
    """ .</pre>
<p>Template blocks define custom views that appear in the UI when viewing resources of the specified type.</p>
</div>
<div>
<h2 id="package-stylesheet">Package stylesheet (layout.xsl)</h2>
<p>XSLT templates using system modes to override default rendering:</p>
<pre>&lt;!-- Hide properties from default property list --&gt;
&lt;xsl:template match="skos:narrower | skos:broader" mode="bs2:PropertyList"/&gt;

&lt;!-- Override XHTML head elements --&gt;
&lt;xsl:template match="*" mode="xhtml:Style"&gt;
    &lt;!-- Custom styles --&gt;
&lt;/xsl:template&gt;</pre>
<p>Available system modes include:</p>
<ul>
<li><code>bs2:*</code> - Bootstrap 2.3.2 components (PropertyList, Form, etc.)</li>
<li><code>xhtml:*</code> - XHTML elements (Style, Script, etc.)</li>
<li>Additional modes documented in the <a href="../stylesheets/" target="_blank">Stylesheets reference</a></li>
</ul>
</div>
<div>
<h2 id="installing-packages">Installing packages</h2>
<p>Installation requires Control access to the administration application. See the <a href="../../../user-guide/manage-packages/" target="_blank">step-by-step installation guide</a> for detailed instructions.</p>
<h3 id="prerequisites">Prerequisites</h3>
<p>Before installing packages, <strong>master stylesheets</strong> must exist in the webapp directory:</p>
<ul>
<li><code>/static/xsl/layout.xsl</code> - End-user application master stylesheet</li>
<li><code>/static/xsl/admin/layout.xsl</code> - Admin application master stylesheet</li>
</ul>
<p>These files are provided in the application at:</p>
<ul>
<li><code>src/main/webapp/static/xsl/layout.xsl</code></li>
<li><code>src/main/webapp/static/xsl/admin/layout.xsl</code></li>
</ul>
<p>Installation will fail with <code>InternalServerErrorException</code> if these files do not exist.</p>
<h3 id="installation-process">Installation process</h3>
<p>When you install a package, the system performs the following steps:</p>
<ol>
<li><strong>Fetches package metadata</strong> from the package URI</li>
<li><strong>Hashes the package ontology URI</strong> using SHA-1 to create a unique document slug</li>
<li><strong>Downloads package ontology</strong> (<code>ns.ttl</code>) and PUTs it as a document to <code>${admin_base}ontologies/{hash}/</code> where <code>{hash}</code> is the SHA-1 hash of the ontology URI</li>
<li><strong>Adds owl:imports</strong> from the namespace ontology to the package ontology in the namespace graph (<code>${admin_base}ontologies/namespace/</code>)</li>
<li><strong>Clears and reloads</strong> the namespace ontology from cache to pick up the new imports</li>
<li><strong>Downloads package stylesheet</strong> (<code>layout.xsl</code>) and saves it to <code>/static/{package-path}/layout.xsl</code> where <code>{package-path}</code> is derived from the package URI (e.g., <code>com/linkeddatahub/packages/skos/</code> for <code>https://packages.linkeddatahub.com/skos/</code>)</li>
<li><strong>Updates master stylesheet</strong> at <code>/static/xsl/layout.xsl</code> by adding import:
<pre>&lt;xsl:import href="../com/atomgraph/linkeddatahub/xsl/bootstrap/2.3.2/layout.xsl"/&gt;  &lt;!-- System --&gt;
&lt;xsl:import href="../com/linkeddatahub/packages/skos/layout.xsl"/&gt;  &lt;!-- Package (added) --&gt;</pre>
</li>
</ol>
</div>
<div>
<h2 id="uninstalling-packages">Uninstalling packages</h2>
<p>Packages can be safely uninstalled, which removes:</p>
<ul>
<li>Package ontology imports from the application</li>
<li>Package-specific data and resources</li>
<li>Associated queries and stylesheets</li>
</ul>
<div class="alert alert-info">
<p><strong>Note:</strong> Uninstalling a package does not remove user-created data that uses the package's vocabulary. The data remains accessible but may not be fully functional without the package.</p>
</div>
</div>
<div>
<h2 id="architecture">Architecture</h2>
<h3 id="installation-time-composition">Installation-time vs runtime</h3>
<p>Packages use <strong>installation-time composition</strong>, NOT runtime composition:</p>
<ul>
<li>✅ Package content is integrated during installation (via JAX-RS endpoints)</li>
<li>✅ Ontology and XSLT are pre-composed before being loaded</li>
<li>✅ No runtime overhead</li>
<li>❌ No dynamic package loading at request time</li>
</ul>
<h3 id="jaxrs-endpoints">JAX-RS endpoints</h3>
<p>On the admin application:</p>
<dl>
<dt>POST <code>/packages/install</code></dt>
<dd>Installs a package. Parameter: <code>package-uri</code> (form-urlencoded). Requires owner/admin authentication. Delegates authenticated agent credentials for PUT requests.</dd>
<dt>POST <code>/packages/uninstall</code></dt>
<dd>Uninstalls a package. Parameter: <code>package-uri</code> (form-urlencoded). Requires owner/admin authentication.</dd>
</dl>
<h3 id="file-system-structure">File system structure</h3>
<p>After installing the SKOS package:</p>
<pre>webapp/
├── static/
│   ├── com/
│   │   └── linkeddatahub/
│   │       └── packages/
│   │           └── skos/
│   │               └── layout.xsl          # Package stylesheet
│   └── xsl/
│       ├── layout.xsl                      # End-user master stylesheet
│       └── admin/
│           └── layout.xsl                  # Admin master stylesheet</pre>
<h3 id="sparql-data-structure">SPARQL data structure</h3>
<pre># In admin SPARQL endpoint at &lt;${admin_base}ontologies/{hash}/&gt;
# Package ontology stored as a document where {hash} is SHA-1 of ontology URI
&lt;https://packages.linkeddatahub.com/skos/ns.ttl&gt; a owl:Ontology ;
    # ... package ontology content ...

# In admin SPARQL endpoint (namespace graph at &lt;${admin_base}ontologies/namespace/&gt;)
# Namespace ontology imports package ontology
&lt;https://localhost:4443/ns#&gt; a owl:Ontology ;
    owl:imports &lt;https://packages.linkeddatahub.com/skos/ns.ttl&gt; .

# In system.trig (application config)
&lt;urn:linkeddatahub:apps/end-user&gt; a lapp:EndUserApplication ;
    ldt:ontology &lt;https://localhost:4443/ns#&gt; ;
    ac:stylesheet &lt;static/xsl/layout.xsl&gt; ;  # Master stylesheet</pre>
</div>
<div>
<h2 id="creating-packages">Creating custom packages</h2>
<p>Developers can create custom packages for their own domain vocabularies. The process involves:</p>
<h3 id="create-directory">Create package directory</h3>
<p>Create a new directory under <code>packages/</code> with your package name:</p>
<pre>mkdir packages/schema.org</pre>
<h3 id="write-ontology">Write package ontology (ns.ttl)</h3>
<p>Create <code>ns.ttl</code> with vocabulary import and template blocks:</p>
<pre>&lt;https://packages.linkeddatahub.com/schema.org/ns.ttl&gt; a owl:Ontology ;
    owl:imports &lt;http://schema.org/&gt; .

# Attach template block to a vocabulary class
schema:Person ldh:template :PersonKnows .

:PersonKnows a ldh:View ;
    dct:title "Knows" ;
    spin:query :SelectPersonKnows .

:SelectPersonKnows a sp:Select ;
    sp:text """
    SELECT DISTINCT ?person
    WHERE { GRAPH ?graph { $about schema:knows ?person } }
    ORDER BY ?person
    """ .</pre>
<h3 id="write-stylesheet">Write XSLT stylesheet (layout.xsl)</h3>
<p>Create <code>layout.xsl</code> with XSLT templates using system modes like <code>bs2:*</code> and <code>xhtml:*</code>. See the <a href="../stylesheets/" target="_blank">Stylesheets reference</a> for template customization patterns.</p>
<pre>&lt;xsl:template match="schema:knows" mode="bs2:PropertyList"/&gt;</pre>
<h3 id="publish-metadata">Publish package metadata</h3>
<p>Publish package metadata as Linked Data at your package URI:</p>
<pre>&lt;https://packages.linkeddatahub.com/schema.org/#this&gt; a lapp:Package ;
    rdfs:label "Schema.org Package" ;
    dct:description "Schema.org vocabulary support" ;
    ldt:ontology &lt;https://raw.githubusercontent.com/you/repo/master/packages/schema.org/ns.ttl&gt; ;
    ac:stylesheet &lt;https://raw.githubusercontent.com/you/repo/master/packages/schema.org/layout.xsl&gt; .</pre>
<p>Ensure the metadata contains <code>ldt:ontology</code> and <code>ac:stylesheet</code> properties pointing to the package resources.</p>
<h3 id="test-installation">Test installation</h3>
<p>Use the CLI to test your package installation:</p>
<pre>install-package.sh \\
  -b "https://localhost:4443/" \\
  -f ssl/owner/cert.pem \\
  -p "$cert_password" \\
  --package "https://packages.linkeddatahub.com/schema.org/#this"</pre>
</div>
<div>
<h2 id="available-packages">Available packages</h2>
<table class="table">
<thead>
<tr>
<th>Package</th>
<th>Description</th>
<th>Vocabulary</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>skos</code></td>
<td>Simple Knowledge Organization System (SKOS) support</td>
<td>SKOS Core</td>
</tr>
</tbody>
</table>
</div>
</div>"""^^rdf:XMLLiteral .
